@{
    ViewBag.Title = @Resources.Strings.FreshFaceHome;
    Layout = "~/Views/Shared/_GridLayout.cshtml";
}

<!-- Start Row -->

<div id="myModal" class="reveal-modal medium pagelinks">
     <p>@Resources.Strings.EnterFriend</p>
     <form name="add_friend" action="" method="get">
        <input type="text" class="friend_email" placeholder="@Resources.Strings.AddFriendPlaceHolder" />
        <a class="addFriend" href="">@Resources.Strings.AddFriend</a>
    </form> 
</div>

<div id="photoModal" class="reveal-modal medium pagelinks">
     <p>@Resources.Strings.EnterPhoto</p>
     <form id="photoForm" name="photoForm" action="" method="post">
        <input type="text" class="photo_url" placeholder="@Resources.Strings.UploadPhotoPlaceholder" />
        <a class="addPhoto" href="">@Resources.Strings.UploadPhoto</a>
    </form> 
</div>

<!-- End Row -->

<div id="fb-root"></div>
<script>
    window.fbAsyncInit = function () {
        FB.init({
            appId: "@ViewBag.AppID",
            status: true,
            cookie: true,
            xfbml: true,
            oauth: true,
            fileUpload: true,
            uploadFile: true
        });
        FB.Event.subscribe('auth.statusChange', function (response) {
            if (!response.authResponse) {
                Debug.log("FB has likely timed us out, log out.");
                FreshFace.logOff();
            }
        });
        $(".logout").click(function (event) {
            FB.logout(function (response) {
                FreshFace.logOff();
            });
            event.preventDefault();
        }
        var addFriend = function (username) {
            FB.ui({ method: 'friends.add', id: username, display: 'popup' });
        }
        $(".addFriend").click(function (event) {
            var friend = $(".friend_email").val();
            addFriend(friend);
            $("#myModal").hide();
        });
        $(".addPhoto").click(function (event) {
            //var album = $(".photo_album").val();
            var photo = $(".photo_url").val();
            var data = {
                url: photo
            };
            //Debug.log($("#photoForm").serialize());
            FB.api("/me/photos", "post", data, function (resp) {
                Debug.log("Posted photo, resp:");
                Debug.log(resp);

                FB.api('/' + resp.id, function (postData) {
                    Debug.log("And the data is...");
                    Debug.log(postData);

                    FreshFace.prependPost($(".ff-feed-parent"), postData, "photo");

                    $("#photoModal").trigger("reveal:close");
                });
            });
            event.preventDefault();
        });
        FB.getLoginStatus(function (logResp) {
            if (logResp.status === 'connected') {
                // Do stuff that we need to be logged in to do
                Debug.log("Logged in!  Can do stuff now.");
                Debug.log(logResp);

                FB.api('/me', function (apiResp) {
                    var uName = apiResp.name;
                    Debug.log("User name: " + uName);
                    Debug.log(apiResp);

                    var fb_url = "https://graph.facebook.com/";
                    fb_url += apiResp.id;
                    var photoUrl = fb_url + "/albums";
                    photoUrl += "?access_token=" + logResp.authResponse.accessToken;
                    photoUrl += "&app_id=" + "@ViewBag.AppID";
                    photoUrl += "&method=post";
                    photoUrl += "&sdk=joey";
                    photoUrl += "&pretty=0";
                    $("#photoForm").attr("action", photoUrl);
                    //$("#photoForm").ajaxForm(function (photoResp) {
                    //    Debug.log(photoResp);
                    //});
                    $(".ff-name").html(uName);
                });
                FB.api('/me/picture', function (apiResp) {
                    Debug.log("Profile pic url: " + apiResp);
                    var img = '<img class="centered" src="' + apiResp + '"></img>';
                    $(".ff-profile-pic").html(img);
                });
                FB.api('/me/home', { limit: 10 }, function (apiResp) {
                    var feedPar = $(".ff-feed-parent");
                    Debug.log("User's feed: " + apiResp);
                    $(apiResp.data).each(function (index, post) {
                        //if (index >= 10) { // TODO: this is not the optimal way to limit the number of news articles...
                        //    return;
                        //}

                        FreshFace.appendPost(feedPar, post);
                    });
                });
            } else {
                Debug.log("Logging out, FB has decided we're done.");
                FreshFace.logOff();
            }
        });
    };
    (function (d) {
        var js, id = 'facebook-jssdk'; if (d.getElementById(id)) { return; }
        js = d.createElement('script'); js.id = id; js.async = true;
        js.src = "//connect.facebook.net/en_US/all.js";
        d.getElementsByTagName('head')[0].appendChild(js);
    } (document));
</script>