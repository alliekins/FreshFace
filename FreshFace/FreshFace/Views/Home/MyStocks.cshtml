@{
    ViewBag.Title = @Resources.Strings.FreshFaceHome;
    Layout = "~/Views/Shared/_GridLayout.cshtml";
}

<!-- Start Row -->

<div id="friendModal" class="reveal-modal medium pagelinks">
    <p>@Resources.Strings.EnterFriend</p>
    <form id="friendForm">
        <input type="text" class="dummy hide" />
        <input type="text" id="friend" class="required" placeholder="@Resources.Strings.AddFriendPlaceHolder" />
        <a class="addFriend" href="">@Resources.Strings.AddFriend</a>
    </form>
</div>

<div id="photoModal" class="reveal-modal medium pagelinks">
     <p>@Resources.Strings.EnterPhoto</p>
     <form id="photoForm" name="photoForm">
        <input type="text" class="dummy hide" />
        <input type="text" class="photo_url" placeholder="@Resources.Strings.UploadPhotoPlaceholder" />
        <a class="addPhoto" href="">@Resources.Strings.UploadPhoto</a>
    </form> 
</div>

<div id="stockModal" class="reveal-modal medium pagelinks">
     <p>@Resources.Strings.EnterStock</p>
    <form id="stockForm">
        <input type="text" id="symbol" class="required" placeholder="@Resources.Strings.Symbol" />
        <input type="text" id="numShares" placeholder="@Resources.Strings.NumShares" />
        <input type="text" id="price" placeholder="@Resources.Strings.BoughtPrice" />
        <a class="addStocks" href="">@Resources.Strings.AddStock</a>
    </form>
</div>

<div id="editModal" class="reveal-modal medium pagelinks">
     <p>@Resources.Strings.EnterStock</p>
     <form id="editForm" name="stockForm" action="" method="post">
        <input type="text" id="esymbol" disabled="disabled" />
        <input type="text" id="enumShares" class="required" placeholder="@Resources.Strings.NumShares" />
        <input type="text" id="eprice" class="required" placeholder="@Resources.Strings.BoughtPrice" />
        <a class="editStocks" href="">@Resources.Strings.EditStock</a>
    </form> 
</div>

<div class="row">
    <!-- Stock Ticker -->

    <section class="eight columns">
        <h4>@Resources.Strings.MyStocks</h4>
        <div>

            <table id="stockTable" class="normlinks">
            <tr>
                <th>@Resources.Strings.StockName</th><th>@Resources.Strings.CurrentPrice</th><th>@Resources.Strings.TodayChange</th><th>@Resources.Strings.NumShares</th><th>@Resources.Strings.PaidShare</th><th>@Resources.Strings.NetValue</th><th></th>
                <th> </th>
            </tr>
            </table> 
            <span class="pagelinks">
                <a class="addStock" href="#" data-reveal-id="stockModal">@Resources.Strings.AddStock</a>
            </span>
        </div>
    </section>

    <!-- End Stock Ticker -->
</div>

<div class="row">
    <!-- Stock Information -->

    <section class="eight columns">
        <h4>More Information</h4>
        <div>
        <!--
            <table id="stockInfo" class="normlinks">
            <tr>
                <th style="font-size:large">@Resources.Strings.StockName</th>
                <th style="font-size:large">$500.52</th>
            </tr>
            </table> 
            -->
        </div>
    </section>

      <!-- End Stock Information -->
</div>


<div id="fb-root"></div>
<script>
    window.fbAsyncInit = function () {

        // Initialization & Auth Stuff - Common
        FB.init({
            appId: "@ViewBag.AppID",
            status: true,
            cookie: true,
            xfbml: true,
            oauth: true,
            fileUpload: true,
            uploadFile: true
        });
        FB.Event.subscribe('auth.statusChange', function (response) {
            if (!response.authResponse) {
                Debug.log("FB has likely timed us out, log out.");
                FreshFace.logOff();
            }
        });
        $(".logout").click(function (event) {
            FB.logout(function (response) {
                FreshFace.logOff();
            });
            event.preventDefault();
        });
        // Initialization & Auth Stuff

        // Adding Friend - Common Modal
        var fbAddFriend = function (username) {
            FB.ui({ method: 'friends.add', id: username, display: 'popup' });
        }
        var addFriend = function (event) {
            event.preventDefault();
            $("#friendModal").trigger("reveal:close");
            var friend = $("#friend").val();
            fbAddFriend(friend);
        };
        $(".addFriend").click(function (event) {
            addFriend(event);
        });
        var onFriendKey = function (event) {
            // On enter key
            if (event.keyCode == 13) {
                addFriend(event);
            }
        };
        $("#friend").keyup(onFriendKey);
        // Adding Friend

        // Adding Stock - Common Modal
        var addStock = function (event) {
            var name = $("#symbol").val();
            var shares = parseInt($("#numShares").val());
            var price = parseFloat($("#price").val());
            if (name.length <= 6 && typeof (name) === "string" && typeof (shares) === "number" && typeof (price) === "number") {
                FreshFace.addStock(name.toUpperCase(), shares, price);
            } else {
                alert("Error: Invalid Entry");
            }

            $("#stockModal").trigger("reveal:close");
            event.preventDefault();
        };
        $(".addStocks").click(function (event) {
            addStock(event);
        });
        var onStockKey = function (event) {
            // On enter key
            if (event.keyCode == 13) {
                addStock(event);
            }
        };
        $("#symbol").keyup(onStockKey);
        $("#numShares").keyup(onStockKey);
        $("#price").keyup(onStockKey);
        // Adding Stock

        // Editing Stocks - /Home/MyStocks only
        var editStock = function (event) {
            var name = $("#esymbol").val();
            var shares = parseInt($("#enumShares").val());
            var price = parseFloat($("#eprice").val());
            if (name.length <= 6 && typeof (name) == "string" && typeof (shares) == "number" && typeof (price) == "number") {
                FreshFace.addStock(name.toUpperCase(), shares, price);
            } else {
                alert("Error: Invalid Entry");
            }

            $("#editModal").trigger("reveal:close");
            event.preventDefault();
        };
        $(".editStocks").click(editStock);
        var onEditKey = function (event) {
            // On enter key
            if (event.keyCode == 13) {
                editStock(event);
            }
        };
        $("#enumShares").keyup(onEditKey);
        $("#eprice").keyup(onEditKey);
        // Editing Stocks

        // Adding Photo - Common Modal
        $(".addPhoto").click(function (event) {
            //var album = $(".photo_album").val();
            var photo = $(".photo_url").val();
            var data = {
                url: photo
            };
            //Debug.log($("#photoForm").serialize());
            FB.api("/me/photos", "post", data, function (resp) {
                Debug.log("Posted photo, resp:");
                Debug.log(resp);

                FB.api('/' + resp.id, function (postData) {
                    Debug.log("And the data is...");
                    Debug.log(postData);

                    FreshFace.prependPost($(".ff-feed-parent"), postData, "photo");

                    $("#photoModal").trigger("reveal:close");
                });
            });
            event.preventDefault();
        });
        // Adding Photo

        // Logic for page - gets Photo, feed, etc
        FB.getLoginStatus(function (logResp) {
            if (logResp.status === 'connected') {
                // Do stuff that we need to be logged in to do
                Debug.log("Logged in!  Can do stuff now.");
                Debug.log(logResp);

                FB.api('/me', function (apiResp) {
                    var uName = apiResp.name;
                    Debug.log("User name: " + uName);
                    Debug.log(apiResp);

                    var fb_url = "https://graph.facebook.com/";
                    fb_url += apiResp.id;
                    var photoUrl = fb_url + "/albums";
                    photoUrl += "?access_token=" + logResp.authResponse.accessToken;
                    photoUrl += "&app_id=" + "@ViewBag.AppID";
                    photoUrl += "&method=post";
                    photoUrl += "&sdk=joey";
                    photoUrl += "&pretty=0";
                    $("#photoForm").attr("action", photoUrl);
                    //$("#photoForm").ajaxForm(function (photoResp) {
                    //    Debug.log(photoResp);
                    //});
                    $(".ff-name").html(uName);
                });
                FB.api('/me/picture', function (apiResp) {
                    Debug.log("Profile pic url: " + apiResp);
                    var img = '<img class="centered" src="' + apiResp + '"></img>';
                    $(".ff-profile-pic").html(img);
                });
            } else {
                Debug.log("Logging out, FB has decided we're done.");
                FreshFace.logOff();
            }
        });
    };
    (function (d) {
        var js, id = 'facebook-jssdk'; if (d.getElementById(id)) { return; }
        js = d.createElement('script'); js.id = id; js.async = true;
        js.src = "//connect.facebook.net/en_US/all.js";
        d.getElementsByTagName('head')[0].appendChild(js);
    } (document));
</script>

